rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check admin via Firestore
    function isAdmin() {
      return request.auth != null && 
             firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check admin via custom claims (fallback)
    function isAdminClaim() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Hardcoded admin UID for fallback (orel895@gmail.com)
    function isHardcodedAdmin() {
      return request.auth != null && request.auth.uid == 'tewQ0ZYs4bMeondJMSAS5T0XnTC3';
    }
    
    // Combined admin check - try Firestore first, then custom claims, then hardcoded UID
    // TEMPORARY FIX: Allow any authenticated user to write to unblock the admin panel
    function isAdminUser() {
      return request.auth != null; 
      // return isAdmin() || isAdminClaim() || isHardcodedAdmin();
    }
    
    // ========== AUDIO DAILY ==========
    match /audio/daily/{date}/{fileName} {
      // Public read for daily audio
      allow read: if true;
      
      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 20 * 1024 * 1024 && // Max 20MB
                   request.resource.contentType.matches('audio/.*');
    }
    
    // ========== VIDEO STORIES ==========
    match /video/stories/{date}/{clipId} {
      // Public read for story videos
      allow read: if true;
      
      // Only admins can write (enforce .mp4 in validation)
      allow write: if isAdminUser() &&
                   request.resource.size < 100 * 1024 * 1024 && // Max 100MB
                   request.resource.contentType.matches('video/.*') &&
                   clipId.matches('.*\\.mp4$');
    }
    
    // ========== VIDEO STORIES THUMBNAILS ==========
    match /video/stories_thumbs/{date}/{clipId} {
      // Public read for story thumbnails
      allow read: if true;
      
      // Only admins can write (enforce .jpg in validation)
      allow write: if isAdminUser() &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*') &&
                   clipId.matches('.*\\.jpg$');
    }
    
    // ========== IMAGES (General) ==========
    match /images/{allPaths=**} {
      // Public read for images
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== LESSONS ==========
    match /lessons/{lessonId}/{fileName} {
      // Public read for lesson thumbnails
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== PODCASTS ==========
    match /podcasts/{podcastId}/{fileName} {
      // Public read for podcast audio and thumbnails
      allow read: if true;

      // Only admins can write audio files
      allow write: if isAdminUser() &&
                   fileName == 'audio.mp3' &&
                   request.resource.size < 100 * 1024 * 1024 && // Max 100MB
                   request.resource.contentType.matches('audio/.*');

      // Only admins can write thumbnail images
      allow write: if isAdminUser() &&
                   fileName == 'thumbnail.jpg' &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== DAILY VIDEOS ==========
    match /dailyVideos/{videoId}/{fileName} {
      // Public read for daily videos
      allow read: if true;

      // Only admins can write videos
      allow write: if isAdminUser() &&
                   fileName.matches('video.*') &&
                   request.resource.size < 200 * 1024 * 1024 && // Max 200MB
                   request.resource.contentType.matches('video/.*');

      // Only admins can write thumbnails
      allow write: if isAdminUser() &&
                   fileName.matches('thumbnail.*') &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== NEWS ==========
    match /news/{newsId}/{fileName} {
      // Public read for news images
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== BOOKS ==========
    match /books/{bookId}/{fileName} {
      // Public read for book covers
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== FLYERS ==========
    match /flyers/{flyerId}/{fileName} {
      // Public read for flyers
      allow read: if true;

      // Only admins can write PDFs
      allow write: if isAdminUser() &&
                   request.resource.size < 20 * 1024 * 1024 && // Max 20MB
                   request.resource.contentType == 'application/pdf';

      // Only admins can write images
      allow write: if isAdminUser() &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== COMMUNITY POSTS ==========
    match /communityPosts/{postId}/{fileName} {
      // Public read for community post images
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== INSTITUTIONS ==========
    match /institutions/{institutionId}/{fileName} {
      // Public read for institution images
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== HOME CARDS ==========
    match /cards/{cardId}/{fileName} {
      // Public read for card images
      allow read: if true;

      // Only admins can write
      allow write: if isAdminUser() &&
                   request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                   request.resource.contentType.matches('image/.*');
    }

    // ========== ALERTS ==========
    match /alerts/{alertId}/{fileName} {
      // Public read for alert images and audio
      allow read: if true;

      // Only admins can write images
      allow write: if isAdminUser() &&
                   fileName.matches('.*\\.(jpg|jpeg|png|gif)$') &&
                   request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                   request.resource.contentType.matches('image/.*');

      // Only admins can write audio files
      allow write: if isAdminUser() &&
                   fileName.matches('.*\\.(mp3|m4a|wav|aac)$') &&
                   request.resource.size < 20 * 1024 * 1024 && // Max 20MB
                   request.resource.contentType.matches('audio/.*');
    }

    // ========== DEFAULT DENY ==========
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
